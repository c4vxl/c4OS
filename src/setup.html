<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Installer</title>

    <link rel="stylesheet" href="assets/style/style.css">

    <link rel="stylesheet" href="assets/style/table.css">

    <link rel="stylesheet" href="assets/style/slider.css">

    <link rel="stylesheet" href="assets/style/console.css">

    <link rel="stylesheet" href="assets/style/choice.css">

    <script src="assets/script/slider.js"></script>
</head>
<body>
    <div class="slider" id="pages">
        <div class="slide__container">
            <div class="slide">
                <h1>Setup Wizzard</h1>

                <div class="slide__content">
                    <p>Welcome to <b>c4OS</b>. We will guide you through the setup of your new installation.</p>
                    <i>No worries. It's gonna be quick.</i>
                </div>
            </div>

            <div class="slide">
                <h1>Let's get to know you</h1>

                <div class="slide__content" style="display: flex; flex-direction: column; align-items: end; width: max-content; gap: 20px;">
                    <div class="row">
                        <label for="setup__input__device__name">Device Name:</label>
                        <div class="info"><span class="tooltip">The name your device is going to be visible as in your network</span></div>
                        <input id="setup__input__device__name" style="width: 30ch;" type="text" class="input" placeholder="Device name" onclick="this.select()" onchange="document.querySelector('#setup__input__bootloader__id').value = this.value;" value="c4OS">
                    </div>
    
                    <div class="row">
                        <label for="setup__input__username">Your Name:</label>
                        <input id="setup__input__username" style="width: 30ch;" type="text" class="input" placeholder="Username" value="owner" required>
                    </div>
    
                    <div class="row">
                        <label for="setup__input__password">Password:</label>
                        <div class="info"><span class="tooltip">Leave empty if no password should be used!</span></div>
                        <input id="setup__input__password" style="width: 30ch;" type="password" class="input" placeholder="Password" onclick="this.select()">
                    </div>

                    <div class="row">
                        <label for="setup__input__keyboard">Keyboard layout:</label>
                        <select id="setup__input__keyboard" class="input" style="width: 30ch;">
                        </select>
                    </div>
                </div>
            </div>

            <div class="slide">
                <h1>Where to install</h1>

                <div class="slide__content">
                    <div class="table" id="partition__list">
                        <div class="row">
                            <p>Name</p>
                            <p>Label</p>
                            <p>Size</p>
                            <p>Type</p>
                            <p>Use as</p>
                        </div>
                    </div>

                    <div style="margin-top: 20px;" id="partition__list__label">
                        <p style="display: inline-block; margin-right: 40px;">EFI: <b id="partition__list__label__efi">None</b></p>
                        <p style="display: inline-block;">Root: <b id="partition__list__label__root">None</b></p>
                    </div>


                    <div class="info"><span class="tooltip">Selected partitions will be formatted to different fs-type. This will result in all data on this partition being lost. <b>BACK UP YOUR DATA!</b></span></div>

                    <hr style="width: 75%; margin: 20px 00px 40px 0px;">

                    <button class="secondary" onclick="document.querySelector('#create__partition__modal').classList.toggle('active')">Create new Partition</button>
                </div>
            </div>

            <div class="slide">
                <h1>Preinstall apps</h1>

                <div class="slide__content">
                    <div class="row">
                        <button style="width: 20ch;" class="secondary" onclick="this.parentNode.parentNode.querySelectorAll('.apps__list .apps__item:not(.active)').forEach(x => x.click());">Select All</button>
                        <button style="width: 20ch;" class="secondary" onclick="this.parentNode.parentNode.querySelectorAll('.apps__list .apps__item.active').forEach(x => x.click())">Select None</button>
                    </div>

                    <br>

                    <div class="apps__list">
                    </div>
                </div>
            </div>

            <div class="slide">
                <h1>Customize the look</h1>

                <i>Note that you'll always be able to change this later in the <b>Themes</b>-App</i>

                <div class="slide__content">
                    <div class="slider" id="themes__slider">
                        <div class="slide__container"></div>
                
                        <div class="slide__indicator" style="width: max-content; margin: 0 auto; gap: 50px;">
                            <p class="prev" style="width: max-content; cursor: pointer; font-size: 150%; transform: rotateZ(180deg);">➭</p>
                            <div class="circle__container"></div>
                            <p class="next" style="width: max-content; cursor: pointer; font-size: 150%;">➭</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="slide">
                <h1>Technical Settings</h1>

                <div class="slide__content" style="display: flex; flex-direction: column; align-items: end; width: max-content; gap: 20px;">
                    <div class="row">
                        <label for="setup__input__swap">Swap size:</label>
                        <div class="info"><span class="tooltip">If your computer runs out of memory, <br><b>swap space</b> helps by temporarily storing data. A larger swap size can improve performance on systems with less RAM</span></div>
                        <input id="setup__input__swap" type="text" class="input" placeholder="Swap size" value="8G" onclick="this.select()">
                    </div>

                    <div class="row">
                        <label for="setup__input__swap">Bootloader ID:</label>
                        <div class="info"><span class="tooltip">The name the installation is going to show up in BIOS.</span></div>
                        <input id="setup__input__bootloader__id" type="text" class="input" placeholder="Bootloader ID" onclick="this.select()" value="c4OS">
                    </div>

                    <div class="row">
                        <label>Desktop environment:</label>
                        <div class="info"><span class="tooltip">The desktop manager you want to install. (If you're unsure, just use GNOME)</span></div>
                        
                        <div class="choice__box" id="setup__input__desktop_env">
                            <div class="selector"></div>
                            <span>None</span>
                            <span class="active">GNOME</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="slide">
                <h1>And that's it</h1>
                <p>Here's a quick overview of your setup:</p>

                <div class="slide__content">
                    <ul id="overview" class="overview">
                        <li>EFI Partition: <highlight id="overview__efi"></highlight></li>
                        <li>Root Partition: <highlight id="overview__root"></highlight></li>
                        <li>Swap size: <highlight id="overview__swap"></highlight></li>
                        <li>Bootloader ID: <highlight id="overview__bootloader__id"></highlight></li>
                        <li>Desktop environment: <highlight id="overview__desktop__env"></highlight></li>

                        <hr style="width: 100%;">

                        <li>Device Name: <highlight id="overview__device__name"></highlight></li>
                        <li>Username: <highlight id="overview__username"></highlight></li>
                        <li>Use Password: <highlight id="overview__use__password"></highlight></li>
                        <li>Theme: <highlight id="overview__theme"></highlight></li>
                        <li>Keyboard Layout: <highlight id="overview__keyboard"></highlight></li>

                        <hr style="width: 100%;">

                        <li>Preinstalled Applications: <highlight id="overview__software"></highlight></li>

                        <hr style="width: 100%;">
                    </ul>
                </div>
            </div>
        </div>

        <div class="slide__indicator">
            <div class="circle__container"></div>
            <div class="row">
                <button class="prev secondary" style="display: none;">Previous</button>
                <button class="next primary">Next</button>
            </div>
        </div>
    </div>

    <div class="notifications"></div>

    <div class="modal active" id="prev__configs__modal">
        <h1>Previous configs</h1>
        <div class="modal__content slide__content" style="margin: auto 0;">
            <div class="table" id="prev__configs__list" style="width: 90vw; max-height: 70vh;">
                <div class="row"><p>Previous configurations</p></div>
            </div>

            <div class="modal">
                <h1 style="font-weight: 200;"><highlight style="margin-top: 3px;"></highlight></h1>

                <div class="modal__content" style="margin: auto 0;">
                    <ul class="overview">
                        <li>EFI Partition: <highlight id="overview__efi"></highlight></li>
                        <li>Root Partition: <highlight id="overview__root"></highlight></li>
                        <li>Swap size: <highlight id="overview__swap"></highlight></li>
                        <li>Bootloader ID: <highlight id="overview__bootloader__id"></highlight></li>
                        <li>Desktop environment: <highlight id="overview__desktop__env"></highlight></li>
        
                        <hr style="width: 100%;">
        
                        <li>Device Name: <highlight id="overview__device__name"></highlight></li>
                        <li>Username: <highlight id="overview__username"></highlight></li>
                        <li>Use Password: <highlight id="overview__use__password"></highlight></li>
                        <li>Keyboard layout: <highlight id="overview__keyboard"></highlight></li>
                        <li>Theme: <highlight id="overview__theme"></highlight></li>
        
                        <hr style="width: 100%;">
        
                        <li>Preinstalled Applications: <highlight id="overview__software"></highlight></li>
        
                        <hr style="width: 100%;">
                    </ul>
        
                    <div class="row">
                        <button class="secondary" onclick="this.parentNode.parentNode.parentNode.classList.remove('active')">Go back</button>
                        <button class="primary" onclick="startInstallation()">Install</button>
                    </div>
                </div>
            </div>

            <hr style="margin: 50px 0; width: 80vw;">
            
            <button class="secondary" onclick="this.parentNode.parentNode.classList.remove('active')">Or configure a new one</button>
        </div>
    </div>

    <div class="modal" id="create__partition__modal">
        <div class="modal__content" style="gap: 20px; align-items: end;">
            <div class="row" style="justify-content: space-between; width: 100%;">
                <label for="new__partition__label">Label:</label>
                <input id="new__partition__label" type="text" class="input" placeholder="Partition Label" onclick="this.select()" value="New Partition">
            </div>

            <div class="row" style="justify-content: space-between; width: 100%;">
                <label for="new__partition__size">Size:</label>
                <input id="new__partition__size" type="text" class="input" placeholder="Size" onclick="this.select()" value="25G">
            </div>

            <div class="row" style="justify-content: space-between; width: 100%;">
                <label for="new__partition__size">FS-Type:</label>
                <div class="info"><span class="tooltip">Use <highlight>fat32</highlight> for your efi partition and <highlight>ext4</highlight> for your root partition.</span></div>

                <select id="new__partition__fstype" class="input">
                    <option value="ext4">ext4</option>
                    <option value="fat32">fat32</option>
                </select>
            </div>

            <div class="row" style="justify-content: space-between; width: 100%;">
                <label for="new__partition__device">Device:</label>

                <select id="new__partition__device" class="input">
                    
                </select>
            </div>

            <div style="margin: 15px auto;" class="row">
                <button class="primary" onclick="handleCreatePartition(); this.parentNode.querySelector('button.secondary').click()">Create</button>
                <button class="secondary" onclick="this.parentNode.parentNode.parentNode.classList.remove('active')">Close</button>
            </div>
        </div>
    </div>

    <div class="modal active" id="network__connection__modal">
        <h1>Set internet connection</h1>
        <div class="modal__content" style="flex-direction: row; gap: 50px;">
            <div style="padding-right: 50px; border-right: 2px solid var(--primary);">
                <div class="option active" id="network__connection__option__wifi">
                    <input type="checkbox" checked disabled>
                    <p>Connect via WIFI</p>
                </div>
                <br>
                <div class="option info no__label" id="network__connection__option__ethernet">
                    <input type="checkbox" disabled>
                    <p>Connect via Ethernet</p>
                    <span class="tooltip" style="top: 100%; right: 100%; display: none;">No ethernet connection detected. Connect your ethernet cable and press <highlight>Reload</highlight>.</span>
                </div>

                <button class="secondary" style="width: 100%; margin-top: 30px;" onclick="initializeConnectionModal()">Reload</button>
            </div>

            <button class="primary" onclick="
                this.parentNode.querySelector('.option.active').id == 'network__connection__option__wifi' ? 
                    document.querySelector('#wifi__connection__modal').classList.add('active')
                : this.parentNode.parentNode.classList.remove('active');
            ">Next</button>
        </div>
    </div>

    <div class="modal" id="wifi__connection__modal">
        <h1>Set internet connection</h1>
        <div class="modal__content" style="width: 90vw; max-width: 150ch;">
            <div class="table" id="wifi__connection__table" style="width: 100%;">
                <div class="row"><p>Available WIFI Networks</p></div>
            </div>

            <div style="margin-top: 30px;" class="row">
                <button class="secondary" onclick="this.parentNode.parentNode.parentNode.classList.remove('active');">Go back</button>
                <button class="primary" onclick="initializeConnectionModal()">Reload</button>
            </div>
        </div>
    </div>

    <div class="modal" id="wifi__ask__for__pw">
        <h1 style="font-weight: 100;">Connect to <highlight>WLAN Arbeitszimmer</highlight></h1>
        <div class="modal__content" style="width: 90vw; max-width: 150ch; margin: auto 0;">
            <div class="row">
                <label for="wifi__password">WIFI Password:</label>
                <input id="wifi__password" type="password" class="input" placeholder="Password" onclick="this.select()">
            </div>            

            <div style="margin-top: 30px;" class="row">
                <button class="secondary" onclick="this.parentNode.parentNode.parentNode.classList.remove('active');">Go back</button>
                <button class="primary" onclick="sendWifiConnectionRequest(this.dataset.w, this.parentNode.parentNode.querySelector('input').value)">Connect</button>
            </div>
        </div>
    </div>

    <div class="modal active" id="startup__modal">
        <h1 style="margin-bottom: auto;">Pick an option</h1>
        <div class="modal__content" style="margin-bottom: auto; flex-direction: row; gap: 50px;">
            <div style="padding-right: 50px; border-right: 2px solid var(--primary);">
                <div class="option active" id="startup__option__wizzard">
                    <input type="checkbox" checked disabled>
                    <p>Open Wizzard</p>
                </div>
                <br>
                <div class="option" id="startup__option__terminal">
                    <input type="checkbox" disabled>
                    <p>Open Terminal</p>
                </div>
                <br>
                <div class="option" id="startup__option__gparted">
                    <input type="checkbox" disabled>
                    <p>Open GParted</p>
                </div>
            </div>

            <button class="primary" onclick="handleStartupOption()">Select</button>
        </div>
    </div>

    <div class="modal" id="installation__modal">
        <h1>Installing...</h1>
        <i>This might take a while. Kick back and relax while we do the work.</i>
        <i style="margin-bottom: auto;"><b>Do not disconnect your computer from the internet</b></i>
        <div class="modal__content" style="margin-bottom: auto; margin-top: 10px;">
            <div class="console__output" id="installation__output"></div>
        </div>
    </div>

    <div class="modal" id="done__modal">
        <h1>All done.</h1>
        <div class="modal__content" style="margin: auto 0;">
            <i>Your installation is done.</i>
            
            <div style="margin-top: 20px;" class="row">
                <button style="width: 30ch;" class="secondary" onclick="window.location.reload();">Restart installer</button>
                <button style="width: 30ch;" class="primary" onclick="fetch('/reboot');">Reboot</button>
            </div>
        </div>
    </div>

    <script>
        let configuration = {};
        let previousConfigs = {};

        /**
         * UI Components
         */
        const openModal = (inner) => document.body.innerHTML += `<div class="modal active" onclick="this.classList.remove('active')"><div class="modal__content">${inner}</div></div>`;
        const createNotification = async (msg) => document.querySelector(".notifications").innerHTML += `<h1 class="notification">${msg}</h1>`;
        const scrollToBottom = (wrapper) => wrapper.scrollTop = wrapper.scrollHeight;
        
        document.querySelectorAll(".choice__box span").forEach(element => {
            element.addEventListener("click", () => {
                [...element.parentNode.querySelectorAll("span")].filter(x => x != element).forEach(x => x.classList.remove("active"));
                element.classList.add("active");
            })
        });

        document.querySelectorAll(".option").forEach(element => {
            element.addEventListener("click", (e) => {
                if (element.classList.contains("disabled")) return;

                let current = element.parentNode.querySelector(".option.active");
                current.classList.remove("active");
                current.querySelector("input").removeAttribute("checked");
                element.classList.add("active");
                element.querySelector("input").setAttribute("checked", true);
            })
        });

        /**
         * Page handling
         */
        const handleStartupOption = () => {
            let option = document.querySelector("#startup__modal .option.active").id;

            let modal = document.querySelector("#startup__modal");
            if (option == "startup__option__wizzard") {
                modal.style.opacity = "0";
                setTimeout(() => modal.remove(), 200);
            } else if (option == "startup__option__gparted") {
                fetch("/gparted");
                return;
            } else if (option == "startup__option__terminal") {
                fetch("/tty");
                return;
            }
        }

        const displayConfiguration = (parent, conf = configuration) => {
            const set = (name, va) => parent.querySelector(`#overview__${name}`).innerHTML = va;
            set("efi", conf.efi);
            set("root", conf.root);
            set("device__name", conf.devicename);
            set("username", conf.username);
            set("theme", conf.theme || "None");
            set("software", conf.software.join(", ") || "None");
            set("swap", conf.swap);
            set("bootloader__id", conf.bootloaderid);
            set("use__password", conf.password != "" ? "Yes" : "No");
            set("desktop__env", conf.desktopenv || "None");
            set("keyboard", conf.keyboard || "us");
        }

        const collectConfiguration = () => {
            const get = (name) => document.querySelector(`#${name}`)?.value;
            const getP = (type) => [...document.querySelectorAll("#partition__list .row")].find(x => x.querySelector("select")?.value == type)?.querySelector("p:first-of-type")?.textContent;

            configuration.devicename = get("setup__input__device__name") || "None";
            configuration.username = get("setup__input__username") || "None";
            configuration.password = get("setup__input__password");
            configuration.software = [...document.querySelectorAll(".apps__list .apps__item.active p")].map(x => x.textContent.toLowerCase().replaceAll(" ", "_"));
            configuration.efi = getP("efi") || "None";
            configuration.root = getP("root") || "None";
            configuration.swap = get("setup__input__swap") || "None";
            configuration.bootloaderid = get("setup__input__bootloader__id") || "None";
            configuration.theme = document.querySelector("#themes__slider .slide.active img").alt;
            configuration.desktopenv = document.querySelector("#setup__input__desktop_env span.active").innerHTML.toLowerCase();
            configuration.keyboard = document.querySelector("#setup__input__keyboard").value;

            displayConfiguration(document.querySelector("#overview"));
        }

        const checkForMissingInputs = () => {
            if (pages.current == 1 && configuration.devicename == "None") return "Device name must be set.";
            if (pages.current == 1 && configuration.username == "None") return "Username must be set.";
            if (pages.current == 2 && configuration.efi == "None") return "Please provide an EFI Partition.";
            if (pages.current == 2 && configuration.root == "None") return "Please provide a Root Partition.";
            if (pages.current == 5 && configuration.swap == "None") return "Swap size must be set.";
            if (pages.current == 5 && configuration.bootloaderid == "None") return "Please enter a bootloader id.";
        }

        const handlePagesButtons = () => {
            pages.prevBtn.style.display = pages.current >= 2 ? "unset" : "none";
            pages.nextBtn.textContent = pages.current === pages.slides.length - 1 ? "Complete" : "Next";
        };

        const pages = new Slider(document.querySelector("#pages"), [], true);
        pages.prevBtn.addEventListener("click", handlePagesButtons);
        pages.nextBtn.addEventListener("click", (e) => {
            collectConfiguration();
            let error = checkForMissingInputs();
            if (error != undefined) {
                createNotification(error);
                return;
            }

            pages.display(pages.current + 1);

            handlePagesButtons();

            if (pages.current == 0) {
                startInstallation();
            }
        });

        // document.querySelector("#startup__modal").classList.remove('active');
        // document.querySelector("#network__connection__modal").classList.remove('active');
        // document.querySelector("#prev__configs__modal").classList.remove('active');
        // pages.display(1);

        /**
         * Theme chooser
         */
        let themes = [ "c4dots/gnome_green_mar_25", "c4dots/gnome_blue_mar_25", "c4dots/gnome_white_mar_25" ];
        const themesSlider = new Slider(document.querySelector("#themes__slider"),
            slides = themes.map(theme => `<div class="slide">
                <h1>${theme.split("/")[1]}</h1>
                <div class="slide__content"><img src="https://raw.githubusercontent.com/${theme}/refs/heads/main/prev/a.png" alt="${theme}"></div>
            </div>`)
        );

        /**
         * Network options
         */
         const initializeConnectionModal = async () => {
            let connectionInfo = await (await fetch("/connectionInfo")).json();
            let isEthernetConnected = connectionInfo.isEthernet;
            let availableNetworks = connectionInfo.availableNetworks;

            // hide network prompt if already connected
            if (connectionInfo.hasConnection) {
                document.querySelector("#network__connection__modal").classList.remove("active");
            }

            // disable ethernet button if ethernet is not connected
            let ethernetOption = document.querySelector("#network__connection__modal #network__connection__option__ethernet");
            if (!isEthernetConnected) {
                ethernetOption.querySelector(".tooltip").style.display = 'unset';
                ethernetOption.classList.add("disabled");
            } else {
                ethernetOption.querySelector(".tooltip").style.display = 'none';
                ethernetOption.classList.remove("disabled");
            }

            // refresh wifi list
            let wifiTable = document.querySelector("#wifi__connection__table");
            wifiTable.querySelectorAll(".row:not(:first-of-type)").forEach(x => x.remove());
            availableNetworks.forEach(network => 
                wifiTable.innerHTML += `<div class="row" onclick="handleWifiConnectButton('${network.ssid}', '${network.password_needed}')" style="cursor: pointer;">
                    <p>${network.ssid}</p>
                </div>`);
        }

        const sendWifiConnectionRequest = async (network, password = null) => {
            console.log(`Sending network connection request: ${network}`);
                
            let success = (await (await fetch(`/connectWifi?ssid=${network}&pw=${password}`)).json()).success;
                
            if (!success) {
                createNotification("Could not connect. Please try again!");
                document.querySelector("#wifi__ask__for__pw #wifi__password").value = "";
                return;
            }

            document.querySelectorAll("img").forEach(x => x.src = `${x.src}#${new Date().getTime()}`);
        
            document.querySelector("#wifi__ask__for__pw").classList.remove("active");
            document.querySelector("#wifi__connection__modal").classList.remove("active");
            document.querySelector("#network__connection__modal").classList.remove("active");

            configuration.wifi = network;
            configuration.wifiPW = password;
        }
        
        const handleWifiConnectButton = (network, need_password) => {
            if (!need_password) {
                sendWifiConnectionRequest(network);
                return;
            }

            document.querySelector("#wifi__ask__for__pw h1 highlight").textContent = network;
            document.querySelector("#wifi__ask__for__pw .primary").dataset.w = network;
            document.querySelector("#wifi__ask__for__pw").classList.add("active");
        }

        initializeConnectionModal();

        /**
         * Software options
         */
        let software = [
            { "icon": "https://code.visualstudio.com/assets/images/code-stable.png", "name": "Visual Studio Code" },
            { "icon": "https://resources.jetbrains.com/storage/products/company/brand/logos/Toolbox.svg", "name": "Jetbrains Toolbox" },
            // { "icon": "https://upload.wikimedia.org/wikipedia/commons/9/9c/IntelliJ_IDEA_Icon.svg", "name": "Intellij" },
            // { "icon": "https://upload.wikimedia.org/wikipedia/commons/1/1d/PyCharm_Icon.svg", "name": "PyCharm" },
            { "icon": "https://obsproject.com/assets/images/new_icon_small.png", "name": "OBS Studio" },
            { "icon": "https://edgestatic.azureedge.net/shared/cms/lrs1c69a1j/section-images/29bfeef37eef4ca3bcf962274c1c7766-png-w256.webp", "name": "Microsoft Edge" },
            { "icon": "https://upload.wikimedia.org/wikipedia/de/2/2e/Mozilla_Firefox_Logo.png", "name": "Firefox" },
            { "icon": "https://upload.wikimedia.org/wikipedia/commons/e/e1/Google_Chrome_icon_%28February_2022%29.svg", "name": "Google Chrome" },
            { "icon": "https://cdn.prod.website-files.com/6257adef93867e50d84d30e2/66e3d80db9971f10a9757c99_Symbol.svg", "name": "Discord" },
            { "icon": "https://www.minecraft.net/content/dam/minecraftnet/franchise/logos/Homepage_Download-Launcher_Creeper-Logo_500x500.png", "name": "Minecraft Launcher" },
            { "icon": "https://www.raspberrypi.com/app/uploads/2022/02/COLOUR-Raspberry-Pi-Symbol-Registered-300x300.png", "name": "Raspberry Pi Imager" },
            // { "icon": "https://cdn-images-1.medium.com/v2/resize:fit:441/1*sIcDb3d42i-AdsZJXL34kw@2x.png", "name": "Google Colab" },
            // { "icon": "https://upload.wikimedia.org/wikipedia/commons/3/33/Figma-logo.svg", "name": "Figma" },
            // { "icon": "https://upload.wikimedia.org/wikipedia/commons/6/66/Google_Docs_2020_Logo.svg", "name": "Google Docs" },
            // { "icon": "https://upload.wikimedia.org/wikipedia/commons/b/b8/YouTube_Logo_2017.svg", "name": "Youtube" },
            // { "icon": "https://upload.wikimedia.org/wikipedia/commons/2/26/Twitch_logo.svg", "name": "Twitch" },
            { "icon": "https://upload.wikimedia.org/wikipedia/commons/0/01/FileZilla_logo.svg", "name": "File Zilla" },
            { "icon": "https://upload.wikimedia.org/wikipedia/commons/8/83/Steam_icon_logo.svg", "name": "Steam" },
            { "icon": "https://download.blender.org/branding/blender_logo.png", "name": "Blender" },
            { "icon": "https://upload.wikimedia.org/wikipedia/commons/5/53/Thunderbird_2023_icon.png", "name": "Thunderbird" },
            { "icon": "https://upload.wikimedia.org/wikipedia/commons/2/2d/Etcher-icon.png", "name": "Balena Etcher" },
            { "icon": "https://apps.gnome.org/icons/scalable/com.github.finefindus.eyedropper.svg", "name": "Eyedropper" }
        ];

        software.forEach(x => {
            document.querySelector(".apps__list").innerHTML += `
            <div class="apps__item" onclick="this.classList.toggle('active')">
                <img src="${x.icon}" alt="${x.name}">
                <p>${x.name}</p>
            </div>
            `
        });


        const handleCreatePartition = async () => {
            let label = document.querySelector("#new__partition__label").value;
            let size = document.querySelector("#new__partition__size").value;
            let fs = document.querySelector("#new__partition__fstype").value;
            let device = document.querySelector("#new__partition__device").value;

            let success = (await (await fetch(`/mkpartition?label=${label}&size=${size}&fs=${fs}&device=${device}`)).json()).success;

            if (success) {
                reloadPartitionList();
                return;
            }

            createNotification("Something went wrong while creating the partition. (Maybe insufficient space)")
        }

        const handlePartitionDropdownChange = (select) => {
            if (select.value != "none") {
                    select.setAttribute("class", "primary");
            } else {
                select.setAttribute("class", "secondary");
            }
            collectConfiguration();
            document.querySelector("#partition__list__label__efi").innerHTML = configuration.efi;
            document.querySelector("#partition__list__label__root").innerHTML = configuration.root;
            [...document.querySelectorAll("#partition__list .row select")]
                .filter(x => x != select && x.value == select.value)
                .forEach(x => { x.value = "none"; x.setAttribute("class", "secondary"); });
        }

        const reloadPartitionList = async () => {
            let response = await (await fetch("/parts")).json();
            let partitions = response.partitions;

            let deviceDropdown = document.querySelector("#new__partition__device");
            deviceDropdown.innerHTML = "";
            response.devices.forEach(x => deviceDropdown.innerHTML += `<option value="${x.name}">${x.name} - ${x.size}</option>`);

            document.querySelectorAll("#partition__list .row:not(:first-of-type)").forEach(x => x.remove());
            configuration.efi = "None";
            configuration.root = "None";
            document.querySelector("#partition__list__label__efi").innerHTML = configuration.efi;
            document.querySelector("#partition__list__label__root").innerHTML = configuration.root;
            partitions.filter(x => x.mount == " -- " || !x.mount).forEach(part => {
                document.querySelector("#partition__list").innerHTML += `
                <div class="row">
                    <p>${part.name}</p>
                    <p>${part.label}</p>
                    <p>${part.size}</p>
                    <p>${part.type}</p>
                    <p><select class="secondary" onchange="handlePartitionDropdownChange(this)"><option value="none" selected>None</option><option value="efi">EFI</option><option value="root">Root</option></select></p>
                </div>`
            });
        }

        reloadPartitionList();

        /**
         * Installation logging
         */
        const startInstallation = async () => {
            let container = document.querySelector("#installation__output");
            document.querySelector("#installation__modal").classList.add("active");

            let url = `/install?${Object.keys(configuration).map(k => `${k}=${configuration[k]}`).join("&")}`;
            const source = new EventSource(url);
            let buffer = [];
            let isUpdating = false;

            source.onmessage = (event) => {
                buffer.push(event.data);
                if (!isUpdating) {
                    isUpdating = true;
                    setTimeout(() => {
                        let newContent = "";
                        buffer.forEach(data => {
                            console.log(data);

                            if (data.startsWith("==done==")) {
                                document.querySelector("#installation__output").innerHTML = "";
                                document.querySelector("#done__modal").classList.add("active");
                                return;
                            }

                            if (data.startsWith(">>> ") && !data.startsWith(">>> xorg")) {
                                container.innerHTML += `
                                <section>
                                    <div class="title row primary" onclick="
                                    [...this.parentNode.parentNode.querySelectorAll('.title')].filter(x => x != this).forEach(x => x.parentNode.classList.remove('active'));
                                    this.parentNode.classList.toggle('active');
                                    scrollToBottom(document.querySelector('#installation__output'));
                                    "><p>${data.replace(">>> ", "")}</p><span>></span></div>
                                    <div class="content"></div>
                                </section>`;

                                document.querySelector("#installation__output section:last-of-type .title").click();
                            } else {
                                newContent += "<span>";
                                for (let char of data) {
                                    if (char === "\b") newContent = newContent.slice(0, -1);
                                    else newContent += char;
                                }
                                newContent += "</span>";
                            }
                        });

                        document.querySelector("#installation__output section:last-of-type .content").innerHTML += newContent;

                        let wrapper = document.querySelector("#installation__output");
                        (wrapper.scrollHeight - wrapper.scrollTop <= wrapper.clientHeight + 400) ? scrollToBottom(wrapper) : null;

                        buffer = [];
                        isUpdating = false;                        
                    }, 100);
                }
            };

            source.onerror = () => {
                source.close();
            };
        }

        /**
         * Prev configs
         */
        const loadPreviousConfigs = async () => {
            // previousConfigs = {"29, March, 2025 - 11:17": {"efi": "/dev/nvme0n1p13", "root": "/dev/nvme0n1p14", "devicename": "c4OS", "username": "owner", "password": "jhkl", "software": "firefox,google_chrome,discord", "swap": "8G", "bootloaderid": "c4OS", "theme": "c4dots/gnome_blue_mar_25", "desktopenv": "gnome"}};
            previousConfigs = await (await fetch("/prevConfigs")).json();
            if (Object.keys(previousConfigs).length === 0) {
                document.querySelector("#prev__configs__modal").remove();
                return;
            }

            Object.entries(previousConfigs).forEach(x => {
                x[1].software = x[1].software.split(",");
            });

            Object.keys(previousConfigs).forEach(conf => {
                document.querySelector("#prev__configs__list").innerHTML += `<div class="row" style="cursor: pointer;" onclick="
                configuration = previousConfigs['${conf}'];
                this.parentNode.parentNode.querySelector('.modal').classList.add('active');
                displayConfiguration(document.querySelector('#prev__configs__modal ul'));
                document.querySelector('#prev__configs__modal highlight').innerHTML = '${conf}';
                ">
                    <p>${conf}</p>
                </div>`;
            });
        }

        loadPreviousConfigs();

        /**
         * Keyboard layouts
         */
         fetch("/keyboards")
            .then(response => response.text())
            .then(layouts => {
                document.querySelector("#setup__input__keyboard").innerHTML += layouts.split("\n").map(x => `<option value="${x}">${x}</option>`);
                document.querySelector("#setup__input__keyboard option[value='us']").setAttribute("selected", undefined);
                configuration.keyboard = "us";
            });
        
        document.querySelector("#setup__input__keyboard").addEventListener("change", (event) => {
            configuration.keyboard = event.target.value;
            fetch(`/loadKeyboard?k=${configuration.keyboard}`);
        });

        document.querySelectorAll("input[type=text]").forEach(x => x.addEventListener("focus", () => x.select()));
    </script>
</body>
</html>